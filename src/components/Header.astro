---
import Button from "./ui-kit/Button.astro";
import MegaMenuCard from "./ui-kit/MegaMenuCard.astro";
import MegaMenuCTA from "./ui-kit/MegaMenuCTA.astro";
import { Mail, Phone, ChevronDown } from "lucide-astro";
---

<header id="main-header" data-theme="dark">
  <div class="header-bg progressive-blur">
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
    <div></div>
  </div>
  <div class="header-container">
    <div class="header-left">
      <a href="/" class="logo" aria-label="Vindex - Retour à l'accueil">
        <img src="/vindex-logo1.svg" alt="Vindex" class="logo-svg" />
      </a>
      <div class="vertical-divider"></div>
    </div>

    <nav>
      <ul>
        <li><a href="/">Accueil</a></li>
        <li><a href="/cabinet">Le Cabinet</a></li>
        <li class="has-dropdown">
          <button
            class="dropdown-trigger"
            aria-expanded="false"
            aria-haspopup="true"
          >
            Expertises
            <svg
              class="chevron"
              width="12"
              height="12"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <polyline points="6 9 12 15 18 9"></polyline>
            </svg>
          </button>
          <div class="mega-menu" id="mega-menu" data-theme="dark">
            <div class="mega-menu-container">
              <MegaMenuCard
                href="/domaines/contentieux-photovoltaique"
                image="/photovoltaiques.webp"
                title="Contentieux Photovoltaïque"
              />
              <MegaMenuCard
                href="/domaines/postulation-appel"
                image="/postulation_appel.webp"
                title="Postulation en Appel"
              />
              <MegaMenuCard
                href="/domaines/procedure-participative"
                image="/procedure_participative.webp"
                title="Procédure Participative"
              />
              <MegaMenuCTA
                href="/contact"
                title="Prendre rendez-vous"
                description="Bénéficiez d'une consultation personnalisée avec nos experts juridiques."
                actionText="Nous contacter"
              />
            </div>
          </div>
        </li>
        <li><a href="/actualites">Actualités</a></li>
        <li><a href="/contact">Contact</a></li>
      </ul>
    </nav>

    <div class="header-right">
      <Button href="/contact" variant="primary" theme="dark" class="header-btn"
        >Prendre rendez-vous</Button
      >
    </div>

    <!-- Mobile Hamburger Button -->
    <button class="hamburger" aria-label="Menu" aria-expanded="false">
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>
</header>

<!-- Mobile Menu Overlay -->
<div class="mobile-menu" id="mobile-menu">
  <div class="mobile-menu-content">
    <nav class="mobile-nav">
      <ul>
        <li><a href="/">Accueil</a></li>
        <li><a href="/cabinet">Le Cabinet</a></li>
        <li class="mobile-dropdown">
          <button class="mobile-dropdown-trigger" aria-expanded="false">
            Expertises
            <ChevronDown class="mobile-chevron" size={18} />
          </button>
          <ul class="mobile-dropdown-menu">
            <li>
              <a href="/domaines/contentieux-photovoltaique"
                >Contentieux Photovoltaïque</a
              >
            </li>
            <li>
              <a href="/domaines/postulation-appel">Postulation en Appel</a>
            </li>
            <li>
              <a href="/domaines/procedure-participative"
                >Procédure Participative</a
              >
            </li>
          </ul>
        </li>
        <li><a href="/actualites">Actualités</a></li>
        <li><a href="/contact">Contact</a></li>
      </ul>
    </nav>

    <div class="mobile-menu-footer">
      <div class="mobile-contact-buttons">
        <a href="mailto:contact@vindex-avocats.fr" class="mobile-outline-btn">
          <Mail size={18} />
          contact@vindex-avocats.fr
        </a>
        <a href="tel:+33123456789" class="mobile-outline-btn">
          <Phone size={18} />
          +33 1 23 45 67 89
        </a>
      </div>
      <Button href="/contact" variant="primary" class="mobile-cta-btn">
        Prendre rendez-vous
      </Button>
    </div>
  </div>
</div>

<style>
  header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: 1000;
    /* height: 90px; Removed fixed height to allow padding to dictate initial size */
    display: flex;
    align-items: center;
    transition: height 0.3s ease;
  }

  /* Progressive Gradient Blur Implementation */
  .progressive-blur {
    position: absolute;
    inset: 0;
    z-index: -1;
    opacity: 0;
    pointer-events: none;
    transition: background 0.3s ease;
  }

  header[data-theme="light"] .progressive-blur {
    background: transparent; /* changed from rgba(255, 255, 255, 0.8) to allow blur effect */
  }

  header[data-theme="dark"] .progressive-blur {
    background: transparent;
  }

  .progressive-blur > div,
  .progressive-blur::before,
  .progressive-blur::after {
    position: absolute;
    inset: 0;
    backdrop-filter: blur(var(--blur-amount));
    mask-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 1) var(--mask-start),
      rgba(0, 0, 0, 0) var(--mask-end)
    );
    -webkit-mask-image: linear-gradient(
      to bottom,
      rgba(0, 0, 0, 1) var(--mask-start),
      rgba(0, 0, 0, 0) var(--mask-end)
    );
  }

  /* Layer definitions: progressively increasing blur from top to bottom */
  .progressive-blur::before {
    --blur-amount: 0.5px;
    --mask-start: 0%;
    --mask-end: 12.5%;
    content: "";
  }
  .progressive-blur div:nth-child(1) {
    --blur-amount: 1px;
    --mask-start: 0%;
    --mask-end: 25%;
  }
  .progressive-blur div:nth-child(2) {
    --blur-amount: 2px;
    --mask-start: 0%;
    --mask-end: 37.5%;
  }
  .progressive-blur div:nth-child(3) {
    --blur-amount: 4px;
    --mask-start: 0%;
    --mask-end: 50%;
  }
  .progressive-blur div:nth-child(4) {
    --blur-amount: 8px;
    --mask-start: 0%;
    --mask-end: 62.5%;
  }
  .progressive-blur div:nth-child(5) {
    --blur-amount: 16px;
    --mask-start: 0%;
    --mask-end: 75%;
  }
  .progressive-blur div:nth-child(6) {
    --blur-amount: 32px;
    --mask-start: 0%;
    --mask-end: 87.5%;
  }
  .progressive-blur::after {
    --blur-amount: 64px;
    --mask-start: 0%;
    --mask-end: 100%;
    content: "";
  }

  .header-container {
    width: 100%;
    max-width: 1440px;
    margin: 0 auto;
    padding: 24px 24px;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .header-left {
    display: flex;
    align-items: center;
    gap: 32px;
  }

  .logo {
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: color 0.3s ease;
  }

  .logo-svg {
    height: 44px;
    width: auto;
    display: block;
    transition: filter 0.3s ease;
  }

  header[data-theme="dark"] .logo {
    color: #f5f5f5;
  }
  header[data-theme="light"] .logo {
    color: #1a1a2d;
  }

  /* Invert logo for light theme (SVG is white by default) */
  header[data-theme="dark"] .logo-svg {
    filter: none;
  }
  header[data-theme="light"] .logo-svg {
    filter: invert(1);
  }

  /* .vertical-divider {
    width: 1px;
    height: 20px;
    transition: background 0.3s ease;
  } */

  header[data-theme="dark"] .vertical-divider {
    background: rgba(245, 245, 245, 0.15);
  }
  header[data-theme="light"] .vertical-divider {
    background: rgba(26, 26, 45, 0.15);
  }

  nav ul {
    display: flex;
    list-style: none;
    gap: 32px;
  }

  nav a {
    text-decoration: none;
    font-family: var(--font-sans);
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.05em;
    transition: color 0.3s ease;
  }

  header[data-theme="dark"] nav a {
    color: rgba(245, 245, 245, 0.6);
  }
  header[data-theme="light"] nav a {
    color: rgba(26, 26, 45, 0.6);
  }

  header nav a:hover {
    color: var(--color-primary);
  }

  nav a:hover {
    color: var(--color-primary);
  }

  /* Dropdown styles */
  .has-dropdown {
    position: relative;
    display: flex;
    align-items: center;
  }

  .dropdown-trigger {
    display: flex;
    align-items: center;
    gap: 6px;
    background: none;
    border: none;
    cursor: pointer;
    font-family: var(--font-sans);
    font-size: 0.85rem;
    font-weight: 400;
    letter-spacing: 0.05em;
    transition: color 0.3s ease;
    padding: 0;
  }

  header[data-theme="dark"] .dropdown-trigger {
    color: rgba(245, 245, 245, 0.6);
  }
  header[data-theme="light"] .dropdown-trigger {
    color: rgba(26, 26, 45, 0.6);
  }

  .dropdown-trigger:hover {
    color: var(--color-primary);
  }

  .chevron {
    transition: transform 0.3s ease;
  }

  .has-dropdown:hover .chevron,
  .has-dropdown.open .chevron {
    transform: rotate(180deg);
  }

  /* Mega Menu Styles */
  .mega-menu {
    position: fixed;
    top: 80px; /* Below header */
    left: 50%;
    transform: translateX(-50%);
    width: 100%;
    max-width: 1440px;
    padding: 24px;
    opacity: 0;
    visibility: hidden;
    pointer-events: none;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
    z-index: 999;
  }

  /* Hover bridge - invisible area to keep menu open when moving mouse */
  .has-dropdown::after {
    content: "";
    position: absolute;
    top: 100%;
    left: -50px;
    right: -50px;
    height: 100px;
    opacity: 0;
    pointer-events: none;
  }

  .has-dropdown:hover::after {
    pointer-events: auto;
  }

  .has-dropdown:hover .mega-menu,
  .mega-menu:hover {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
  }

  .mega-menu-container {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 12px;
  }

  @media (max-width: 1024px) {
    .mega-menu-container {
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
  }

  @media (max-width: 768px) {
    .mega-menu-container {
      grid-template-columns: 1fr;
      gap: 12px;
    }
  }

  .header-right {
    display: flex;
    align-items: center;
  }

  /* Hamburger Button - hidden by default */
  .hamburger {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    gap: 5px;
    width: 40px;
    height: 40px;
    background: none;
    border: none;
    cursor: pointer;
    padding: 8px;
    z-index: 1001;
  }

  .hamburger-line {
    width: 24px;
    height: 2px;
    background: currentColor;
    transition: all 0.3s ease;
  }

  header[data-theme="dark"] .hamburger {
    color: #f5f5f5;
  }

  header[data-theme="light"] .hamburger {
    color: #1a1a2d;
  }

  /* Hamburger X animation when open */
  .hamburger.active .hamburger-line:nth-child(1) {
    transform: translateY(7px) rotate(45deg);
  }

  .hamburger.active .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  .hamburger.active .hamburger-line:nth-child(3) {
    transform: translateY(-7px) rotate(-45deg);
  }

  /* Desktop breakpoint adjustments */
  @media (max-width: 1024px) {
    .header-container {
      padding: 0 30px;
    }
    nav ul {
      gap: 20px;
    }
  }

  /* Mobile breakpoint at 960px */
  @media (max-width: 960px) {
    nav,
    .header-right,
    .vertical-divider {
      display: none;
    }

    .hamburger {
      display: flex;
    }

    .header-container {
      padding: 16px 24px;
    }
  }
</style>

<style is:global>
  /* Mobile Menu - needs global scope as it's outside header */
  .mobile-menu {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background: #08110f;
    z-index: 999;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
    display: none;
    flex-direction: column;
  }

  @media (max-width: 960px) {
    .mobile-menu {
      display: flex;
    }
  }

  .mobile-menu.active {
    opacity: 1;
    visibility: visible;
  }

  .mobile-menu-content {
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    height: 100%;
    padding: 96px 24px 24px;
    overflow-y: auto;
  }

  .mobile-nav {
    display: block !important;
    width: 100%;
  }

  .mobile-nav ul {
    list-style: none;
    padding: 0;
    margin: 0;
    display: flex;
    flex-direction: column;
    width: 100%;
  }

  .mobile-nav > ul > li {
    border-bottom: 1px solid rgba(255, 255, 255, 0.08);
  }

  .mobile-nav > ul > li > a,
  .mobile-dropdown-trigger {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
    padding: 12px 0;
    font-family: var(--font-serif) !important;
    font-size: 1rem !important;
    font-weight: 400;
    color: #f5f5f5;
    text-decoration: none;
    background: none;
    border: none;
    text-align: left;
  }

  .mobile-nav > ul > li > a:hover,
  .mobile-dropdown-trigger:hover {
    color: var(--color-primary);
  }

  .mobile-chevron {
    transition: transform 0.3s ease;
    opacity: 0.6;
  }

  .mobile-dropdown-trigger[aria-expanded="true"] .mobile-chevron {
    transform: rotate(180deg);
  }

  .mobile-dropdown-menu {
    max-height: 0;
    overflow: hidden;
    transition: max-height 0.3s ease;
    padding-left: 0;
  }

  ul .mobile-dropdown-menu.open {
    gap: 0px !important;
  }

  .mobile-dropdown-menu.open {
    max-height: 300px;
    padding-bottom: 16px;
  }

  .mobile-dropdown-menu li {
    border-bottom: none;
  }

  .mobile-dropdown-menu a {
    display: block;
    padding: 12px 0;
    padding-left: 16px;
    font-family: var(--font-serif) !important;
    font-size: 0.875rem !important;
    color: rgba(255, 255, 255, 0.6);
    text-decoration: none;
    transition: color 0.2s ease;
    letter-spacing: 0.01em;
  }

  .mobile-dropdown-menu a:hover {
    color: var(--color-primary);
  }

  .mobile-menu-footer {
    margin-top: auto;
    /* padding-top: 32px; */
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .mobile-contact-buttons {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .mobile-outline-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 8px;
    padding: 14px 20px;
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: 4px;
    color: #f5f5f5;
    text-decoration: none;
    font-size: 0.9rem;
    font-family: var(--font-sans);
    transition: all 0.2s ease;
  }

  .mobile-outline-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  .mobile-cta-btn {
    width: 100%;
    margin-top: 8px;
  }

  /* When menu is open, force white logo and hamburger */
  .hamburger.active {
    color: #f5f5f5 !important;
  }

  .hamburger.active .hamburger-line {
    background: #f5f5f5 !important;
  }

  /* Force header logo to be white when menu is open */
  body:has(.mobile-menu.active) #main-header .logo-svg {
    filter: none !important;
  }

  body:has(.mobile-menu.active) #main-header {
    z-index: 1000;
  }
</style>

<script>
  import gsap from "gsap";
  import { ScrollTrigger } from "gsap/ScrollTrigger";

  gsap.registerPlugin(ScrollTrigger);

  const header = document.querySelector("#main-header");
  const progressiveBlur = document.querySelector(".progressive-blur");
  const logo = document.querySelector(".logo");
  const navLinks = document.querySelectorAll("nav a");
  const divider = document.querySelector(".vertical-divider");

  if (header && progressiveBlur) {
    // Header shrink and blur animations (can run immediately)
    gsap.to(progressiveBlur, {
      opacity: 1,
      scrollTrigger: {
        trigger: "body",
        start: "top +=50",
        end: "top +=200",
        scrub: true,
      },
    });

    gsap.to(header, {
      height: "80px",
      scrollTrigger: {
        trigger: "body",
        start: "top +=50",
        end: "top +=200",
        scrub: true,
      },
    });

    const headerContainer = document.querySelector(".header-container");
    if (headerContainer) {
      gsap.to(headerContainer, {
        paddingTop: "16px",
        paddingBottom: "16px",
        scrollTrigger: {
          trigger: "body",
          start: "top +=50",
          end: "top +=200",
          scrub: true,
        },
      });
    }

    // Initialize Theme Switching Logic from external script
    import("../scripts/headerTheme").then(({ initHeaderThemeLogic }) => {
      initHeaderThemeLogic();
    });
  }

  // Mobile Menu Toggle
  const hamburger = document.querySelector(".hamburger");
  const mobileMenu = document.getElementById("mobile-menu");
  const mobileDropdownTrigger = document.querySelector(
    ".mobile-dropdown-trigger",
  );
  const mobileDropdownMenu = document.querySelector(".mobile-dropdown-menu");

  if (hamburger && mobileMenu) {
    hamburger.addEventListener("click", () => {
      const isOpen = hamburger.classList.toggle("active");
      mobileMenu.classList.toggle("active");
      hamburger.setAttribute("aria-expanded", isOpen.toString());

      // Prevent body scroll when menu is open
      document.body.style.overflow = isOpen ? "hidden" : "";
    });

    // Close menu when clicking a link
    const mobileLinks = mobileMenu.querySelectorAll("a");
    mobileLinks.forEach((link) => {
      link.addEventListener("click", () => {
        hamburger.classList.remove("active");
        mobileMenu.classList.remove("active");
        document.body.style.overflow = "";
      });
    });
  }

  // Mobile Dropdown Toggle
  if (mobileDropdownTrigger && mobileDropdownMenu) {
    mobileDropdownTrigger.addEventListener("click", () => {
      const isExpanded =
        mobileDropdownTrigger.getAttribute("aria-expanded") === "true";
      mobileDropdownTrigger.setAttribute(
        "aria-expanded",
        (!isExpanded).toString(),
      );
      mobileDropdownMenu.classList.toggle("open");
    });
  }
</script>
